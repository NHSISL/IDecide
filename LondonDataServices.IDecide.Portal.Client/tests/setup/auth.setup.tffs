import { test as setup, expect } from '@playwright/test';
import {
    clickStartButton,
    fillNhsLoginCredentials,
    clickContinueButton,
    handleOtpIfPrompted
} from '../helpers/helper';

const authFile = 'playwright/.auth/user.json';

setup('authenticate with NHS Login', async ({ page }) => {
    // Navigate to home page
    await page.goto('https://localhost:5173/home');

    // Perform NHS Login authentication
    await clickStartButton(page);
    await expect(page).toHaveURL('https://access.sandpit.signin.nhs.uk/login');

    await fillNhsLoginCredentials(page);
    await clickContinueButton(page);

    // Handle OTP if prompted (will remember device)
    await handleOtpIfPrompted(page);

    // Wait for redirect back to app
    await page.waitForURL(/https:\/\/localhost:5173/);

    // Save authenticated state including cookies and localStorage
    await page.context().storageState({ path: authFile });

    console.log('? Authentication completed and saved to', authFile);
});